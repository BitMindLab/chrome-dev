var bg = chrome.extension.getBackgroundPage();
window.addEventListener("load", function() {
    function p(a) {
        if ("number" != typeof a) throw Error("Parameter error, need timestamp!");
        var b = new Date(2016, 11, 1);
        if (a >= b) return 29;
        if (a >= new Date(2016, 10, 1)) return 29 + Math.floor((b - a) / 864E5)
    }

    function q(a) {
        return a + p(a) * k
    }

    function r(a) {
        return a < new Date(2016, 11, 30) ? a - 59 * k : a - 29 * k
    }

    function H(a) {
        $.ajax({
            url: "http://kyfw.12306.cn/otn/resources/images/bg_navlist.png?_" + Math.random(),
            cache: !1,
            data: null,
            timeout: 1E3,
            type: "POST",
            success: function(b, c, d) {
                b = +new Date(d.getResponseHeader("Date") ||
                    +new Date);
                a(b)
            },
            error: function(b, c, d) {
                b = +new Date(b.getResponseHeader("Date") || +new Date);
                a(b)
            }
        })
    }

    function y(a, b) {
        if ("number" != typeof b) throw Error("Parameter error, need count");
        var c = a + b * k,
            d = Math.floor((c - 14228928E5) / k),
            z = "";
        14228928E5 <= c && 14259168E5 > c && d < A.length && (z = "\uff08" + A[d] + "\uff09");
        var h = new Date(c),
            c = h.getFullYear(),
            d = h.getMonth() + 1,
            h = h.getDate();
        return c + "-" + (9 < d ? d : "0" + d) + "-" + (9 < h ? h : "0" + h) + z
    }

    function s(a) {
        q(a);
        return !1
    }

    function n(a, b) {
        m.css({
            display: "none"
        });
        I(a, b);
        var c = b && b.stamp ?
            (new Date(+b.stamp)).pattern("yyyy-MM-dd") : J,
            d = $("#book_notify_audio");
        B.slideDown(function() {
            $("#date_picker").prop("readOnly", !0).datepicker({
                minDate: 0,
                dateFormat: "yy-mm-dd"
            }).val(c).change(function() {
                var a = +new Date,
                    b = (new Date(a)).pattern("yyyy-MM-dd"),
                    a = (new Date(q(a))).pattern("yyyy-MM-dd"),
                    c = $(this).val(),
                    d = r(+new Date(c)),
                    e = new Date(d),
                    e = e.pattern("yyyy-MM-dd"),
                    f = 0;
                s(d) ? (f = (new Date(d - 5 * k)).pattern("yyyy-MM-dd"), $("#editor_notify_temp").show()) : $("#editor_notify_temp").hide();
                c < b ? ($(".editor-content").hide(),
                    $("#editor_tips_available").hide(), $("#editor_tips_expire").show(), $(".editor-tips").fadeIn()) : c <= a ? ($(".editor-content").hide(), $("#editor_tips_expire").hide(), $("#editor_tips_available").show(), $(".editor-tips").fadeIn()) : ($(".editor-tips").hide(), $(".editor-content").show(), $("#date_notify").html(e), $("#date_notify_temp").html(f))
            })
        });
        b && b.audioPlay || !b ? d.attr("checked", "checked") : d.removeAttr("checked");
        t.animate({
            scrollTop: 0
        }, 200)
    }

    function u(a) {
        B.slideUp(function() {
            "function" === typeof a ? a() :
                m.slideDown()
        })
    }

    function C() {
        g = JSON.parse(localStorage.notification_array);
        g.forEach(function(a) {
            var b = +a.stamp,
                c = new Date(b),
                d = c.getHours(),
                e = c.getMinutes(),
                d = 9 < d ? d : "0" + d,
                e = 9 < e ? e : "0" + e;
            a.ticketDate = c.pattern("yyyy-MM-dd");
            s(b) && "number" !== typeof a.temped ? (a.ticketDate += "\uff08\u6709\u4e34\u5ba2\uff09", a.notifyDate = (new Date(b - 5 * k)).pattern("yyyy-MM-dd") + "\uff0c" + c.pattern("yyyy-MM-dd")) : a.notifyDate = (new Date(r(b))).pattern("yyyy-MM-dd");
            a.notifyTime = d + "\u65f6" + e + "\u5206";
            a.checked = a.audioPlay ? "checked" :
                ""
        });
        $(".notify-recorder").html(K.render({
            recorder: g
        }))
    }

    function I(a, b) {
        var c = b && b.stamp ? +b.stamp : +e.stamp,
            d = r(c),
            f = new Date(d),
            h = f.getHours(),
            g = f.getMinutes(),
            h = 9 < h ? h : "0" + h,
            g = 9 < g ? g : "0" + g;
        e.ticketDate = (new Date(c)).pattern("yyyy-MM-dd");
        e.notifyDate = f.pattern("yyyy-MM-dd");
        c = null;
        s(d) && (c = new Date(d - 5 * k), e.notifyDateTemp = c.pattern("yyyy-MM-dd"));
        e.hour = h;
        e.minute = g;
        e.cancelable = void 0 !== a ? a : 0 < e.length;
        e.isEdit = void 0 !== b;
        $(".notify-editor").html(L.render({
            editor: e
        }));
        null !== c && $("#editor_notify_temp").show();
        $("#book_time_hour").on("keyup", function() {
            var a = $(this).val();
            /^((0?|1)[0-9])$|^(2[0-3])$/.test(a) || "" === a ? "" !== a && (v = a) : $(this).val(v)
        }).blur(function() {
            $(this).val($(this).val() || v)
        });
        $("#book_time_minute").on("keyup", function() {
            var a = $(this).val();
            /^[0-5]?[0-9]$/.test(a) || "" === a ? "" !== a && (w = a) : $(this).val(w)
        }).blur(function() {
            $(this).val($(this).val() || w)
        })
    }

    function M(a) {
        bg.Notify.add(a, function(a) {
            u(function() {
                C();
                m.slideDown()
            })
        })
    }

    function D(a, b) {
        $(".recorder[stamp=" + a + "]").slideUp(function() {
            bg.Notify.remove(+a);
            g = JSON.parse(localStorage.notification_array);
            $(this).remove();
            console.log(g);
            0 === g.length && n(!1, void 0);
            "function" === typeof b && b()
        })
    }

    function N(a) {
        f && f.slideDown();
        f = $(".recorder[stamp=" + a + "]");
        f.slideUp(function() {
            var b = bg.Notify.getNotify(+a);
            n(!0, b)
        })
    }

    function O() {
        m.on("click", function() {
            n(!0, void 0)
        });
        $(document).on("click", ".btn-close", function() {
            window.close()
        }).on("click", ".cons-item", function() {
            var a = $(this).attr("href"),
                b = $(this).attr("dotUrl");
            bg.openPage(a, b);
            window.close()
        }).on("click",
            ".btn-recorder-delete",
            function() {
                D($(this).attr("stamp"), null)
            }).on("click", ".btn-recorder-edit", function() {
            N($(this).attr("stamp"))
        }).on("click", "#btn_editor_confirm_only, #btn_editor_confirm", function() {
            f && (bg.Notify.remove(+f.attr("stamp")), f.remove(), f = null);
            var a = M,
                b = $("#date_picker").val(),
                b = b + " " + $("#book_time_hour").val(),
                b = b + ":",
                b = b + $("#book_time_minute").val();
            console.log(b);
            var c = {};
            c.audioPlay = $("#book_notify_audio").is(":checked");
            c.stamp = +new Date(b);
            a(c)
        }).on("click", "#btn_editor_cancel",
            function() {
                u(function() {
                    e.isEdit && f.slideDown();
                    m.slideDown()
                })
            }).on("click", ".title", function() {
            var a = $(this).index();
            $(".title").removeClass("active");
            $(this).addClass("active");
            0 === a ? (t.hide(), E.show()) : (E.hide(), t.show())
        })
    }
    Date.prototype.pattern = function(a) {
        var b = {
                "M+": this.getMonth() + 1,
                "d+": this.getDate(),
                "h+": this.getHours(),
                "H+": this.getHours(),
                "m+": this.getMinutes(),
                "s+": this.getSeconds(),
                "q+": Math.floor((this.getMonth() + 3) / 3),
                S: this.getMilliseconds()
            },
            c = {
                0: "\u65e5",
                1: "\u4e00",
                2: "\u4e8c",
                3: "\u4e09",
                4: "\u56db",
                5: "\u4e94",
                6: "\u516d"
            };
        /(y+)/.test(a) && (a = a.replace(RegExp.$1, this.getFullYear().toString().substr(4 - RegExp.$1.length)));
        /(E+)/.test(a) && (a = a.replace(RegExp.$1, (1 < RegExp.$1.length ? 2 < RegExp.$1.length ? "\u661f\u671f" : "\u5468" : "") + c[this.getDay().toString()]));
        for (var d in b) b.hasOwnProperty(d) && RegExp("(" + d + ")").test(a) && (a = a.replace(RegExp.$1, 1 === RegExp.$1.length ? b[d] : ("00" + b[d]).substr(("" + b[d]).length)));
        return a
    };
    jQuery(function(a) {
        a.datepicker.regional["zh-CN"] = {
            closeText: "\u5173\u95ed",
            prevText: "<\u4e0a\u6708",
            nextText: "\u4e0b\u6708>",
            currentText: "\u4eca\u5929",
            monthNames: "\u4e00\u6708 \u4e8c\u6708 \u4e09\u6708 \u56db\u6708 \u4e94\u6708 \u516d\u6708 \u4e03\u6708 \u516b\u6708 \u4e5d\u6708 \u5341\u6708 \u5341\u4e00\u6708 \u5341\u4e8c\u6708".split(" "),
            monthNamesShort: "\u4e00 \u4e8c \u4e09 \u56db \u4e94 \u516d \u4e03 \u516b \u4e5d \u5341 \u5341\u4e00 \u5341\u4e8c".split(" "),
            dayNames: "\u661f\u671f\u65e5 \u661f\u671f\u4e00 \u661f\u671f\u4e8c \u661f\u671f\u4e09 \u661f\u671f\u56db \u661f\u671f\u4e94 \u661f\u671f\u516d".split(" "),
            dayNamesShort: "\u5468\u65e5 \u5468\u4e00 \u5468\u4e8c \u5468\u4e09 \u5468\u56db \u5468\u4e94 \u5468\u516d".split(" "),
            dayNamesMin: "\u65e5\u4e00\u4e8c\u4e09\u56db\u4e94\u516d".split(""),
            weekHeader: "\u5468",
            dateFormat: "yy-mm-dd",
            firstDay: 1,
            isRTL: !1,
            showMonthAfterYear: !0,
            yearSuffix: "\u5e74"
        };
        a.datepicker.setDefaults(a.datepicker.regional["zh-CN"])
    });
    var k = 864E5,
        F = $(".install-cert"),
        G = $(".main"),
        m = $("#btn_add_notify"),
        B = $(".notify-editor"),
        f = null,
        E = $(".access"),
        t = $(".notify"),
        P = bg.isCertInstalled(),
        x = [{
                className: "item-ticket",
                title: "360\u62a2\u7968\u4e94\u4ee3",
                desc: "\u81ea\u52a8\u8bc6\u522b\u9a8c\u8bc1\u7801\uff0c\u62a2\u7968\u5feb\u4eba\u4e00\u6b65",
                href: "http://pc.huochepiao.360.cn/?src=ext",
                dotUrl: "http://dd.browser.360.cn/static/a/26.3261.gif"
            }, {
                className: "item-ticket-app",
                title: "\u624b\u673a\u62a2\u7968",
                desc: "\u8d85\u5f3a\u62a2\u7968\u6a21\u5f0f\uff0c\u4eba\u5de5\u673a\u56682\u500d\u4fdd\u969c",
                href: "http://12306.360.cn/?from=ext#shouJiQiangPiao",
                dotUrl: "http://dd.browser.360.cn/static/a/377.5837.gif"
            },
            {
                className: "item-ticket-new",
                title: "12306\u7f51\u7ad9",
                href: "https://kyfw.12306.cn/otn/login/init",
                dotUrl: "http://dd.browser.360.cn/static/a/26.4256.gif"
            }, {
                className: "item-ticket-zhuanti",
                title: "\u62a2\u7968\u6d3b\u52a8",
                href: "http://12306.360.cn/?from=crx"
            }
        ];
    0 < bg.serverConfig.popupList_newui.length && (x = bg.serverConfig.popupList_newui, x.forEach(function(a) {
        a.icon && (a.backgroundStyle = " style=background-image:url(" + a.icon + ")")
    }));
    var g = [],
        l = q(+new Date) + k,
        J = (new Date(l)).pattern("yyyy-MM-dd"),
        v = "07",
        w = "30",
        e = {
            audioPlay: !0,
            stamp: l
        },
        A = "\u814a\u6708\u5341\u4e94 \u814a\u6708\u5341\u516d \u814a\u6708\u5341\u4e03 \u814a\u6708\u5341\u516b \u814a\u6708\u5341\u4e5d \u814a\u6708\u4e8c\u5341 \u814a\u6708\u5eff\u4e00 \u814a\u6708\u5eff\u4e8c \u814a\u6708\u5eff\u4e09 \u814a\u6708\u5eff\u56db \u814a\u6708\u5eff\u4e94 \u814a\u6708\u5eff\u516d \u814a\u6708\u5eff\u4e03 \u814a\u6708\u5eff\u516b \u814a\u6708\u5eff\u4e5d \u9664\u5915 \u6625\u8282 \u6b63\u6708\u521d\u4e8c \u6b63\u6708\u521d\u4e09 \u6b63\u6708\u521d\u56db \u6b63\u6708\u521d\u4e94 \u6b63\u6708\u521d\u516d \u6b63\u6708\u521d\u4e03 \u6b63\u6708\u521d\u516b \u6b63\u6708\u521d\u4e5d \u6b63\u6708\u521d\u5341 \u6b63\u6708\u5341\u4e00 \u6b63\u6708\u5341\u4e8c \u6b63\u6708\u5341\u4e09 \u6b63\u6708\u5341\u56db \u6b63\u6708\u5341\u4e94 \u6b63\u6708\u5341\u516d \u6b63\u6708\u5341\u4e03 \u6b63\u6708\u5341\u516b \u6b63\u6708\u5341\u4e5d \u6b63\u6708\u4e8c\u5341".split(" "),
        l = window.t,
        Q = new l($("#access_template").html()),
        K = new l($("#notify_recorder_template").html()),
        L = new l($("#notify_editor_template").html());
    (function() {
        g = JSON.parse(localStorage.notification_array);
        $(".tips-emphasize").html(y(+new Date, p(+new Date)));
        H(function(a) {
            $(".tips-emphasize").html(y(a, p(a)));
            $("#temp-train")[0].style.display = "none";
            $("#temp-train-tip")[0].style.display = "inline-block"
        });
        $(".access").html(Q.render({
            access: x
        }));
        C();
        0 === g.length ? n(!1, void 0) : u(null);
        P ? G.show() : (F.show(), $(".btn-install").on("click",
            function(a) {
                a.preventDefault();
                "btn_install" === this.id ? bg.installCert() ? F.fadeOut(function() {
                    G.fadeIn()
                }) : ($("#btn_install")[0].style.display = "none", $("#btn_install_error")[0].style.display = "inline-block") : "btn_install_error" === this.id && (bg.openPage("http://bbs.360safe.com/thread-475000-1-1.html", void 0), window.close())
            }));
        O();
        $.get("http://dd.browser.360.cn/static/a/26.6786.gif?_" + Math.random())
    })();
    window.removeNotify = function(a) {
        D(a, null)
    };
    document.oncontextmenu = function() {
        return !1
    }
});